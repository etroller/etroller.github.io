<!DOCTYPE html>
<html>

<head>
    <!-- Google Tag Manager -->
    <script>(function (w, d, s, l, i) {
            w[l] = w[l] || []; w[l].push({
                'gtm.start':
                    new Date().getTime(), event: 'gtm.js'
            }); var f = d.getElementsByTagName(s)[0],
                j = d.createElement(s), dl = l != 'dataLayer' ? '&l=' + l : ''; j.async = true; j.src =
                    'https://www.googletagmanager.com/gtm.js?id=' + i + dl; f.parentNode.insertBefore(j, f);
        })(window, document, 'script', 'dataLayer', 'GTM-MCBGXPDC');</script>
    <!-- End Google Tag Manager -->

    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Agendamento Funil (Preview)</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    animation: {
                        'fade-in': 'fadeIn 0.5s ease-out',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0', transform: 'translateY(10px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        },
                    },
                },
            },
        }
    </script>
</head>

<body class="bg-gray-50 min-h-screen flex items-center justify-center font-sans">

    <!-- Google Tag Manager (noscript) -->
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-MCBGXPDC" height="0" width="0"
            style="display:none;visibility:hidden"></iframe></noscript>
    <!-- End Google Tag Manager (noscript) -->

    <div id="root" class="w-full"></div>

    <script type="text/babel">
        const { useState } = React;

        const questions = [
            {
                id: 'name',
                type: 'text',
                question: 'Como podemos te chamar?',
                placeholder: 'Seu nome completo',
                required: true,
            },
            {
                id: 'challenge',
                type: 'radio',
                question: 'Qual √© o seu principal desafio hoje?',
                options: [
                    'Aumentar vendas',
                    'Melhorar processos',
                    'Contratar equipe',
                    'Outro',
                ],
                required: true,
            },
            {
                id: 'email',
                type: 'email',
                question: 'Qual seu melhor e-mail para contato?',
                placeholder: 'nome@empresa.com',
                required: true,
            },
        ];

        function AgendamentoFunil() {
            const [currentStep, setCurrentStep] = useState(-1); // Start at -1 for Intro Screen
            const [answers, setAnswers] = useState({});
            const [isAnimating, setIsAnimating] = useState(false);
            const [utmData, setUtmData] = useState({});
            const [sessionId, setSessionId] = useState('');

            const currentQuestion = questions[currentStep];
            const isLastStep = currentStep === questions.length;
            const isIntro = currentStep === -1;

            // Capture UTMs, Session ID, and Track ViewContent on mount
            React.useEffect(() => {
                // UTMs
                const params = new URLSearchParams(window.location.search);
                const utms = {};
                for (const [key, value] of params.entries()) {
                    utms[key] = value;
                }
                setUtmData(utms);

                // Session ID
                let sid = localStorage.getItem('sessionId');
                if (!sid) {
                    try {
                        sid = crypto.randomUUID();
                    } catch (e) {
                        sid = Math.random().toString(36).substring(2) + Date.now().toString(36);
                    }
                    localStorage.setItem('sessionId', sid);
                }
                setSessionId(sid);

                // Meta Pixel: ViewContent
                if (typeof fbq === 'function') {
                    fbq('track', 'ViewContent', { content_name: 'Funil Agendamento' });
                }
            }, []);

            // Send to n8n function
            const sendToN8n = async (data) => {
                try {
                    await fetch('https://webhook.geracaosolarengenharia.com.br/webhook/2d4b5478-41bb-4e5c-a662-e6f9a6284fc3', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(data),
                    });
                } catch (error) {
                    console.error('Error sending data to n8n:', error);
                }
            };

            // Debounce effect for sending data
            React.useEffect(() => {
                if (!sessionId) return;

                const timer = setTimeout(() => {
                    const payload = {
                        sessionId,
                        current_step: currentStep,
                        answers,
                        utms: utmData,
                    };
                    sendToN8n(payload);
                }, 1000);

                return () => clearTimeout(timer);
            }, [currentStep, answers, utmData, sessionId]);

            const handleNext = () => {
                if (isLastStep) return;

                // Meta Pixel: InitiateCheckout (Intro -> Step 1)
                if (isIntro && typeof fbq === 'function') {
                    fbq('track', 'InitiateCheckout', { content_name: 'Funil Agendamento' });
                }

                setIsAnimating(true);
                setTimeout(() => {
                    setCurrentStep((prev) => prev + 1);
                    setIsAnimating(false);
                }, 300);
            };

            const handleAnswer = (value) => {
                setAnswers({ ...answers, [currentQuestion.id]: value });
            };

            const isValid = () => {
                if (isLastStep || isIntro) return true;
                const answer = answers[currentQuestion.id];
                if (!answer) return false;
                if (currentQuestion.type === 'email') {
                    return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(answer);
                }
                return true;
            };

            const handleFinish = async () => {
                // Meta Pixel: Lead (Enriched)
                if (typeof fbq === 'function') {
                    const fullName = answers['name'] || '';
                    const nameParts = fullName.trim().split(' ');
                    const firstName = nameParts[0] || '';
                    const lastName = nameParts.slice(1).join(' ') || '';

                    fbq('track', 'Lead', {
                        content_name: 'Agendamento Conclu√≠do',
                        em: answers['email'],
                        fn: firstName,
                        ln: lastName
                    });
                }

                // Send immediately before redirect
                const payload = {
                    sessionId,
                    current_step: currentStep,
                    answers,
                    utms: utmData,
                    completed: true
                };
                await sendToN8n(payload);
                window.location.href = 'https://calendly.com/PLACEHOLDER_URL';
            };

            if (isIntro) {
                return (
                    <div className={`w-full max-w-2xl mx-auto p-6 transition-opacity duration-300 ${isAnimating ? 'opacity-0' : 'opacity-100'}`}>
                        <div className="flex flex-col items-start text-left">
                            <h1 className="text-4xl md:text-5xl font-bold text-gray-900 mb-8 leading-tight">
                                Sua cl√≠nica n√£o pode depender de indica√ß√µes. Nosso m√©todo traz pacientes todos os dias.
                            </h1>

                            <ul className="space-y-6 text-left mb-10 w-full max-w-md">
                                <li className="flex items-center text-xl text-gray-700">
                                    <span className="mr-3 text-2xl">üèÉ‚Äç‚ôÄÔ∏è</span>
                                    <span><strong>Fluxo di√°rio</strong> de novos pacientes</span>
                                </li>
                                <li className="flex items-center text-xl text-gray-700">
                                    <span className="mr-3 text-2xl">üíé</span>
                                    <span><strong>Mais previsibilidade</strong> e lucro</span>
                                </li>
                                <li className="flex items-center text-xl text-gray-700">
                                    <span className="mr-3 text-2xl">üéØ</span>
                                    <span><strong>P√∫blico qualificado</strong> pra sua especialidade</span>
                                </li>
                                <li className="flex items-center text-xl text-gray-700">
                                    <span className="mr-3 text-2xl">‚úÖ</span>
                                    <span><strong>M√©todo validado</strong> para cl√≠nicas particulares</span>
                                </li>
                            </ul>

                            <button
                                onClick={handleNext}
                                className="w-full max-w-md bg-green-800 hover:bg-green-900 text-white font-bold py-4 px-8 rounded-xl transition-all transform hover:scale-105 shadow-lg text-lg mb-6"
                            >
                                Quero melhorar minha cl√≠nica ‚Üí
                            </button>

                            <p className="text-sm text-gray-500 italic">
                                ‚Üí Exclusivo para cl√≠nicas com faturamento m√≠nimo de R$20K/m√™s
                            </p>
                        </div>
                    </div>
                );
            }

            if (isLastStep) {
                return (
                    <div className="w-full max-w-lg mx-auto p-6 animate-fade-in">
                        <div className="bg-white rounded-2xl shadow-xl p-8 text-center">
                            <h2 className="text-3xl font-bold text-gray-800 mb-4">Tudo pronto!</h2>
                            <p className="text-gray-600 mb-8">Obrigado por compartilhar suas informa√ß√µes. Vamos agendar nossa conversa.</p>
                            <button
                                onClick={handleFinish}
                                className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 px-8 rounded-xl transition-all transform hover:scale-105 shadow-lg"
                            >
                                Agendar Reuni√£o Agora
                            </button>
                        </div>
                    </div>
                );
            }

            return (
                <div className="w-full max-w-2xl mx-auto p-4">
                    {/* Progress Bar - Hidden on Intro */}
                    {!isIntro && (
                        <div className="fixed top-0 left-0 w-full h-2 bg-gray-200 z-50">
                            <div
                                className="h-full bg-blue-600 transition-all duration-500 ease-out"
                                style={{ width: `${((currentStep + 1) / questions.length) * 100}%` }}
                            />
                        </div>
                    )}

                    <div className={`transition-opacity duration-300 ${isAnimating ? 'opacity-0' : 'opacity-100'}`}>
                        <div className="mb-8 pt-12">
                            <span className="text-blue-600 font-semibold text-sm uppercase tracking-wider">
                                Passo {currentStep + 1} de {questions.length}
                            </span>
                            <h2 className="text-3xl md:text-4xl font-bold text-gray-900 mt-2 leading-tight">
                                {currentQuestion.question}
                            </h2>
                        </div>

                        <div className="mb-8">
                            {currentQuestion.type === 'text' && (
                                <input
                                    type="text"
                                    value={answers[currentQuestion.id] || ''}
                                    onChange={(e) => handleAnswer(e.target.value)}
                                    placeholder={currentQuestion.placeholder}
                                    className="w-full text-2xl md:text-3xl border-b-2 border-gray-300 focus:border-blue-600 outline-none py-2 bg-transparent transition-colors placeholder-gray-300"
                                    autoFocus
                                    onKeyDown={(e) => e.key === 'Enter' && isValid() && handleNext()}
                                />
                            )}

                            {currentQuestion.type === 'email' && (
                                <input
                                    type="email"
                                    value={answers[currentQuestion.id] || ''}
                                    onChange={(e) => handleAnswer(e.target.value)}
                                    placeholder={currentQuestion.placeholder}
                                    className="w-full text-2xl md:text-3xl border-b-2 border-gray-300 focus:border-blue-600 outline-none py-2 bg-transparent transition-colors placeholder-gray-300"
                                    autoFocus
                                    onKeyDown={(e) => e.key === 'Enter' && isValid() && handleNext()}
                                />
                            )}

                            {currentQuestion.type === 'radio' && (
                                <div className="space-y-3">
                                    {currentQuestion.options.map((option, idx) => (
                                        <button
                                            key={idx}
                                            onClick={() => {
                                                handleAnswer(option);
                                            }}
                                            className={`w-full text-left p-4 rounded-xl border-2 transition-all text-lg font-medium ${answers[currentQuestion.id] === option
                                                ? 'border-blue-600 bg-blue-50 text-blue-700'
                                                : 'border-gray-200 hover:border-blue-300 hover:bg-gray-50 text-gray-700'
                                                }`}
                                        >
                                            <span className="mr-3 text-blue-500 font-bold">{String.fromCharCode(65 + idx)}</span>
                                            {option}
                                        </button>
                                    ))}
                                </div>
                            )}
                        </div>

                        <button
                            onClick={handleNext}
                            disabled={!isValid()}
                            className={`px-8 py-3 rounded-lg font-bold text-lg transition-all ${isValid()
                                ? 'bg-blue-600 text-white shadow-lg hover:bg-blue-700 transform hover:-translate-y-1'
                                : 'bg-gray-200 text-gray-400 cursor-not-allowed'
                                }`}
                        >
                            Continuar
                        </button>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<AgendamentoFunil />);
    </script>
</body>

</html>
